<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Verification</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
:root{
  --bg:#0b0e18;
  --card:#12162a;
  --border:#1f243a;

  --primary:#6ae3ff;
  --secondary:#9b6bff;
  --accent:#4dffb3;
  --danger:#ff6b6b;

  --text:#ffffff;
  --muted:#9aa4c7;
  --mono:'Courier New',monospace;
}

*{margin:0;padding:0;box-sizing:border-box}
html,body{
  width:100%;height:100%;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display",Segoe UI;
  color:var(--text);
  overflow:hidden;
}

.bg{
  position:fixed;inset:-30%;
  background:
    radial-gradient(40% 40% at 20% 20%, var(--primary), transparent 60%),
    radial-gradient(40% 40% at 80% 25%, var(--secondary), transparent 60%),
    radial-gradient(40% 40% at 50% 80%, var(--accent), transparent 60%);
  filter:blur(120px);
  opacity:.35;
}

.app{
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:env(safe-area-inset-top) env(safe-area-inset-right)
          env(safe-area-inset-bottom) env(safe-area-inset-left);
}

.panel{
  width:92%;
  max-width:430px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:26px;
  padding:26px;
}

/* üåë HEADER */
.header{
  text-align:center;
  margin-bottom:8px;
  font-size:20px;
  opacity:.9;
}

.circle{
  width:90px;height:90px;margin:0 auto 12px;
  border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:34px;
  background:linear-gradient(145deg,var(--primary),var(--secondary));
}

h1{text-align:center;font-size:24px}
.sub{text-align:center;font-size:13px;color:var(--muted);margin:6px 0 22px}

/* MESSAGE */
.notice{
  padding:16px 18px;
  border-radius:18px;
  display:flex;
  gap:14px;
  align-items:flex-start;
  background:rgba(255,255,255,.05);
}
.nIcon{
  width:40px;height:40px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#0004;
  margin-top:2px;
}
.nText{
  font-size:14px;
  font-weight:600;
  line-height:1.4;
  padding-top:6px;
}

.row{
  display:flex;justify-content:space-between;
  padding:14px 0;border-bottom:1px solid var(--border);
}
.label{font-size:11px;color:var(--muted)}
.value{
  font-family:var(--mono);
  color:var(--primary);
  user-select:none;
}

.track{
  height:6px;background:#fff2;border-radius:6px;
  overflow:hidden;margin-top:22px;
}
.fill{
  height:100%;width:0%;
  background:linear-gradient(90deg,var(--secondary),var(--primary));
  transition:width linear;
}

.expiry{
  display:none;margin-top:22px;
  padding:20px;border-radius:20px;
  text-align:center;
  background:rgba(77,255,179,.12);
}
.timer{font-family:var(--mono);font-size:28px}

button{
  margin-top:26px;width:100%;
  padding:15px;border-radius:18px;
  border:1px solid var(--danger);
  background:transparent;color:var(--danger);
  font-weight:700;
}
</style>
</head>

<body>
<div class="bg"></div>

<div class="app">
<div class="panel">

  <div class="header">üåë</div>

  <div class="circle" id="topIcon">‚è≥</div>
  <h1 id="title">VERIFYING</h1>
  <div class="sub" id="subtitle">Checking device authorization‚Ä¶</div>

  <div class="notice">
    <div class="nIcon" id="msgIcon">‚Ä¢</div>
    <div class="nText" id="msgText">wait for connecting..</div>
  </div>

  <div class="row">
    <span class="label">DEVICE ID</span>
    <span class="value" id="deviceId">‚Äî</span>
  </div>

  <div class="row">
    <span class="label">TOKEN</span>
    <span class="value" id="userId">‚Äî</span>
  </div>

  <div class="track" id="windowCloseArea">
    <div class="fill" id="progressBar"></div>
  </div>

  <div class="expiry" id="expiryArea">
    <div class="timer" id="expiryTimer">00:00:00</div>
  </div>

  <button id="closeBtn">CLOSE</button>

</div>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyBeHXB_9nHTWofFeXKOVUlQYCrB4YhAx_w",
  databaseURL:"https://real-apk-pin-default-rtdb.firebaseio.com"
});
const database=firebase.database();

/* ================= ELEMENTS ================= */
const topIcon=document.getElementById('topIcon');
const msgText=document.getElementById('msgText');
const titleEl=document.getElementById('title');
const subtitleEl=document.getElementById('subtitle');
const deviceEl=document.getElementById('deviceId');
const userEl=document.getElementById('userId');
const bar=document.getElementById('progressBar');
const expiryArea=document.getElementById('expiryArea');
const expiryTimer=document.getElementById('expiryTimer');
const closeBtn=document.getElementById('closeBtn');

/* ================= PARAMS ================= */
const p=new URLSearchParams(location.search);
const deviceId=p.get('device');
const code=p.get('code');
const slotId=p.get('uid');
deviceEl.textContent=deviceId||'‚Äî';

/* ================= DOUBLE TAP COPY (DEVICE ID) ================= */
let lastTap=0;
deviceEl.addEventListener('touchend',()=>{
  const now=Date.now();
  if(now-lastTap<300){
    copyText(deviceEl.textContent);
    showCopied();
  }
  lastTap=now;
});

/* COPY HELPERS */
function copyText(t){
  if(!t||t==='‚Äî')return;
  if(navigator.clipboard){
    navigator.clipboard.writeText(t).catch(()=>fallbackCopy(t));
  }else fallbackCopy(t);
}
function fallbackCopy(t){
  const ta=document.createElement('textarea');
  ta.value=t;document.body.appendChild(ta);
  ta.select();document.execCommand('copy');ta.remove();
}
function showCopied(){
  const old=deviceEl.textContent;
  deviceEl.textContent=old+" ‚úì";
  deviceEl.style.color='var(--accent)';
  setTimeout(()=>{
    deviceEl.textContent=old;
    deviceEl.style.color='var(--primary)';
  },800);
}

/* ================= LOGIC ================= */
function setError(msg){
  topIcon.textContent='‚úñ';
  titleEl.textContent='FAILED';
  subtitleEl.textContent=msg;
  msgText.textContent='Access Denied';
  startClose(5);
}
function setSuccess(){
  topIcon.textContent='‚úî';
  titleEl.textContent='SUCCESS';
  subtitleEl.textContent='Device Authorized';
  msgText.textContent='Access Granted';
}
function startClose(sec){
  bar.style.transition=`width ${sec}s linear`;
  bar.style.width='100%';
  setTimeout(()=>window.close(),sec*1000);
}
function startExpiry(ts){
  expiryArea.style.display='block';
  const i=setInterval(()=>{
    const d=ts-Date.now();
    if(d<=0){expiryTimer.textContent='EXPIRED';clearInterval(i);return;}
    const h=Math.floor(d/3600000);
    const m=Math.floor(d%3600000/60000);
    const s=Math.floor(d%60000/1000);
    expiryTimer.textContent=
      String(h).padStart(2,'0')+':' +
      String(m).padStart(2,'0')+':' +
      String(s).padStart(2,'0');
  },1000);
}

/* ================= VERIFY ================= */
async function verify(){
 try{
  if(!deviceId||!code||!slotId){setError('Invalid Params');return;}
  const ref=database.ref(`users/${slotId}/verification_codes/${code}`);
  const snap=await ref.once('value');
  const data=snap.val();

  if(!data){setError('Wrong Code');return;}
  if(data.used){setError('Code Already Used');return;}
  if(data.deviceId!==deviceId){setError('Device Mismatch');return;}

  const now=Date.now();
  await ref.update({used:true,used_at:now});
  setSuccess();
  userEl.textContent=data.access_token||'AUTHORIZED';

  const cfg=await database.ref(`users/${slotId}/config`).once('value');
  const min=parseInt(cfg.val()?.verification_minutes||1440);
  startExpiry(now+min*60000);

 }catch(e){
  setError('Connection Error');
 }
}

closeBtn.onclick=()=>window.close();
window.onload=verify;
</script>

</body>
</html>